<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="assets/cmc-icon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Item Details - CraftersMC Guides</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="js/script.js"></script>
  <style>
    .login-btn { background-color: #5865F2; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; transition: bottom 0.5s ease-in-out; z-index: 10001; white-space: pre-line; }
    .toast-notification.show { bottom: 30px; }
    .toast-notification.success { background-color: #2d8831; }
    .toast-notification.error { background-color: #c62828; }
    .private-item-highlight { border: 2px dashed #ff9800; background-color: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
    .profile-card {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1001;
      display: none;
      align-items: center;
      gap: 15px;
      background: linear-gradient(135deg, rgba(40, 40, 40, 0.7), rgba(25, 25, 25, 0.8));
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 50px;
      color: white;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255, 255, 255, 0.15);
      animation: fade-in-down 0.5s ease-out forwards;
      min-width: 200px;
    }
    .profile-card:hover { background-color: rgba(0, 0, 0, 0.8); transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
    #user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); transition: box-shadow 0.3s; }
    #user-details { text-align: left; }
    #user-name { font-size: 18px; font-weight: 700; line-height: 1.2; }
    #user-tag { font-size: 12px; font-weight: 700; text-transform: uppercase; opacity: 0.9; margin-top: 3px; display: block; letter-spacing: 0.5px; }
    .profile-card.role-dev #user-avatar { box-shadow: 0 0 15px rgba(213, 0, 0, 0.8); }
    .profile-card.role-manager #user-avatar { box-shadow: 0 0 15px rgba(255, 193, 7, 0.8); }
    .profile-card.role-data-manager #user-avatar { box-shadow: 0 0 15px rgba(41, 98, 255, 0.8); }
    .profile-card.role-rank-seller #user-avatar { box-shadow: 0 0 15px rgba(0, 200, 83, 0.8); }
    @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) {
      .profile-card { top: 65px; right: 10px; padding: 8px 14px; gap: 12px; min-width: 0; }
      #user-avatar { width: 40px; height: 40px; }
      #user-name { font-size: 16px; }
      #user-tag { font-size: 10px; }
    }
    .role-action-btn {
      position: fixed;
      top: 148px;
      right: 20px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 700;
      border-radius: 10px;
      background: linear-gradient(135deg, #5865F2, #4752C4);
      color: #fff;
      border: none !important;
      outline: none !important;
      cursor: pointer;
      z-index: 1001;
      transition: transform .2s ease, filter .2s ease, background .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      white-space: nowrap;
      user-select: none;
    }
    .role-action-btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
    .role-action-btn:active { transform: translateY(0); filter: brightness(.98); }
    .role-action-btn:focus-visible { outline: none !important; box-shadow: 0 0 0 2px rgba(88,101,242,.25), 0 6px 16px rgba(0,0,0,.35); }
    .role-action-btn .material-icons { font-size: 18px; line-height: 1; }
    @media (max-width: 768px) {
      .role-action-btn { top: 118px; right: 10px; padding: 8px 12px; font-size: 12px; border-radius: 8px; }
    }
    #price-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #price-modal .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      width: 320px;
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    #price-modal h2 { margin-bottom: 15px; font-size: 20px; }
    #price-modal label { display: block; margin: 10px 0 5px; }
    #price-modal input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      margin-bottom: 10px;
    }
    #price-modal .btn-submit {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #5865F2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #price-modal .btn-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      float: right;
      cursor: pointer;
    }
.expected-input {
  display: none;
  position: absolute;
  top: 550px;
  right: 150px;
  width: 20px;   /* your width */
  height: 20px;
  z-index: 9999;
}
    .expected-btn{
      display: none;
      position: absolute;
      top: 25px;
      right: 25px;
      z-index: 9999;
      width: 10px;
      height: 10px;
    }
    .expected{
      color: yellow;
      text-align: center;
      height: 30px;
      width: 110px;
      position: absolute;
      top: 75px;
      left: 25px;
      background: aqua;
      border-radius: 10px;
      box-shadow: 5px;
    }
    .exp-display{
      display: block;
    }
  </style>
</head>
<body>
  <div id="loader"><div></div><div></div><div></div></div>
  <div class="market-background"></div>

  <a href="/profile.html" class="profile-card" id="profile-card">
    <img id="user-avatar" src="https://placehold.co/110x110/dddddd/333333?text=...&font=inter" alt="User Avatar" />
    <div id="user-details">
      <div id="user-name">Loading...</div>
      <div id="user-tag"></div>
    </div>
  </a>

  <!-- Button will be injected here if allowed -->
  <div id="role-btn-container"></div>

  <!-- Modal for changing price -->
  <div id="price-modal">
    <div class="modal-content">
      <button class="btn-close" onclick="closePriceModal()">×</button>
      <h2 id="modal-item-name">Item Name</h2>

      <label for="modal-market-price">Market Price</label>
      <input type="number" id="modal-market-price" />
      <label for="modal-npc-price">NPC Price</label>
      <input type="number" id="modal-npc-price" />
      <button class="btn-submit" onclick="submitPriceModal()">Submit</button>
    </div>
  </div>

  <div class="top"></div>
  <div class="sidebar" id="sidebar"></div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
  <span class="item-material-icons" id="scrollToTopBtn">north</span>

  <div class="gap"></div>

  <div class="item-filter-buttons" style="display:flex;gap:10px;justify-content:center;margin:5rem 0;">
    <button class="btn item-filter-btn" data-nature="reset">Reset Filter</button>
  </div>
  <div class="expected">Expected!</div>
        <input class="expected-input" type="number">
      <div class="expected-btn">DONE!</div>
  <div class="item-container" id="itemDetails"><p>Loading item details...</p></div>
  <div class="item-nav-buttons">
    <button id="prevItemBtn" class="btn" type="button">&larr; Previous</button>
    <button id="nextItemBtn" class="btn" type="button">Next &rarr;</button>
  </div>
  <div id="footer"></div>

  <script>
    let isDevUser = false;
    let allItems = [];
    const expected = document.querySelector(".expected");
const expInput = document.querySelector(".expected-input");

expected.addEventListener("click", () => {
  expInput.classList.toggle("exp-display");
});

    function getCookie(name) { const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift()); return ''; }

    async function loadUserInfo() {
      const profileCard = document.getElementById('profile-card');
      const defaultAvatar = "https://placehold.co/110x110/dddddd/333333?text=...&font=inter";
      const avatarEl = document.getElementById('user-avatar');
      const nameEl = document.getElementById('user-name');
      const tagEl = document.getElementById('user-tag');
      const roleBtnContainer = document.getElementById('role-btn-container');
      try {
        const storedUserCookie = getCookie('discordUser');
        if (!storedUserCookie) { profileCard.style.display = 'none'; return; }
        const loggedInUser = JSON.parse(storedUserCookie);
        const userId = loggedInUser.id;
        if (!userId) { profileCard.style.display = 'none'; return; }
        const response = await fetch(`https://discord-auth.roumakdatta.workers.dev/users/${userId}`);
        if (!response.ok) { profileCard.style.display = 'none'; return; }
        const user = await response.json();
        profileCard.style.display = 'flex';
        const avatarUrl = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : defaultAvatar;
        avatarEl.src = avatarUrl;
        avatarEl.onerror = () => { avatarEl.src = defaultAvatar; };
        nameEl.textContent = user.global_name || user.username || 'Unknown User';
        const roleColors = { dev: '#d50000', manager: '#ffc107', "data manager": '#2962ff', "rank seller": '#00c853' };
        const userRole = user.role ? user.role.toLowerCase() : '';
        profileCard.classList.remove('role-dev', 'role-manager', 'role-data-manager', 'role-rank-seller');
        if (userRole && userRole !== 'normal user') {
          const roleClass = userRole.replace(' ', '-');
          profileCard.classList.add(`role-${roleClass}`);
        }
        if (roleColors[userRole]) {
          tagEl.textContent = user.role.toUpperCase();
          tagEl.style.color = roleColors[userRole];
        } else {
          tagEl.textContent = '';
          tagEl.style.color = '';
        }
        if (["dev", "manager", "data manager"].includes(userRole)) {
          const btn = document.createElement("button");
          btn.className = "role-action-btn";
          btn.id = "role-action-btn";
          btn.innerHTML = `<span class="material-icons">edit</span> Change Price`;
          btn.addEventListener("click", openPriceModal);
          roleBtnContainer.appendChild(btn);
        }
      } catch (err) {
        console.error('Error in loadUserInfo function:', err);
        profileCard.style.display = 'none';
      }
    }

    async function fetchAllItems() { try { const res = await fetch("market/market.txt"); allItems = await res.json(); } catch (e) { console.error("Could not fetch market.txt", e); } }

    async function loadItemDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');
      if (itemId) {
        try {
          const storedUser = getCookie("discordUser");
          if (storedUser) {
            let devIds = [];
            try {
              const response = await fetch('/devs.txt');
              if (response.ok) {
                const text = await response.text();
                devIds = text.split('\n').map(id => id.trim()).filter(id => id);
              }
            } catch (error) { console.error('Error TwT:', error); }
            const user = JSON.parse(storedUser);
            isDevUser = devIds.includes(user.id);
          }
          const [marketRes, pricesRes] = await Promise.all([fetch('market/market.txt'), fetch('market/mprices.txt')]);
          const marketData = await marketRes.text();
          const pricesData = await pricesRes.text();
          const items = JSON.parse(marketData);
          const item = items.find(item => item.id === itemId);
          if (item) {
            const isPublic = item.hasOwnProperty("public") ? item.public : true;
            if (!isPublic && !isDevUser) { document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`; return; }
            const pricesMap = new Map(); const npcPricesMap = new Map();
            pricesData.split('\n').forEach(line => {
              const [id, arrayStr] = line.split(':').map(part => part.trim());
              if (id && arrayStr) {
                try {
                  const parsedArray = JSON.parse(arrayStr);
                  if (Array.isArray(parsedArray) && parsedArray.length >= 2) {
                    pricesMap.set(id, parsedArray[1]);
                    if (parsedArray.length >= 3) { npcPricesMap.set(id, parsedArray[2]); }
                  }
                } catch (e) { console.error(e) }
              }
            });
            const marketPrice = pricesMap.get(item.id) ?? item.price ?? "N/A";
            const npcPrice = npcPricesMap.get(item.id);
            let privateHighlight = (isDevUser && !isPublic) ? `<div class='private-item-highlight'>PRIVATE ITEM (Visible only to Devs)</div>` : '';
            document.getElementById('itemDetails').innerHTML = `${privateHighlight}<h1>${item.name}</h1>
            ${item.picture ? `<img src="${item.picture}" alt="${item.name}">` : ''}
            ${item.rarity ? `<div class="item-rarity-display"><img class="item-rarity" src="img/rarity/${item.rarity}.webp"></div>` : ''}
            <p><strong class="item-strong">ID:</strong> ${item.id}</p><div class="item-price-container"><p class="item-price"><strong>Market Price:</strong> ${formatPrice(marketPrice)}</p><hr width="150px">${npcPrice !== null && npcPrice !== undefined ? `<p class="item-price"><strong>NPC Trade Price:</strong> ${formatPrice(npcPrice)}</p>` : ''}</div>`;
            
            // preload modal with values
            document.getElementById('modal-item-name').textContent = item.name;
            document.getElementById('modal-market-price').value = marketPrice !== "N/A" ? marketPrice : "";
            document.getElementById('modal-npc-price').value = npcPrice ?? "";
          } else {
            document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: This item doesn't exist.</h2>`;
          }
        } catch (error) {
          console.error('Error loading item details:', error);
          document.getElementById('itemDetails').innerHTML = `<h2 style="color:red;">Error: Could not load item details.</h2>`;
        }
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add('show'); }, 100);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
    }

    function formatPrice(price) {
      if (price === "N/A" || price === "NAN" || price === null || price === undefined) { return `N/A`; }
      return `${Number(price).toLocaleString()}c`;
    }

    function goToPrevItem() {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (isNaN(id) || id <= 1) return;
      if (isDevUser) {
        window.location.href = `item.html?item=${id - 1}`;
      } else {
        let prevId = id - 1;
        while (prevId > 0) {
          const prevItem = allItems.find(i => i.id == prevId);
          if (prevItem && (prevItem.public === undefined || prevItem.public)) { window.location.href = `item.html?item=${prevId}`; return; }
          prevId--;
        }
      }
    }

    function goToNextItem() {
      const urlParams = new URLSearchParams(window.location.search);
      let id = parseInt(urlParams.get("item"), 10);
      if (isNaN(id)) return;
      if (isDevUser) {
        window.location.href = `item.html?item=${id + 1}`;
      } else {
        let nextId = id + 1;
        while (nextId <= allItems.length + 1000) {
          const nextItem = allItems.find(i => i.id == nextId);
          if (nextItem && (nextItem.public === undefined || nextItem.public)) { window.location.href = `item.html?item=${nextId}`; return; }
          nextId++;
        }
      }
    }

    function openPriceModal() {
      document.getElementById('price-modal').style.display = 'flex';
    }
    function closePriceModal() {
      document.getElementById('price-modal').style.display = 'none';
    }

    async function submitPriceModal() {
      try {
        const storedUserCookie = getCookie('discordUser');
        if (!storedUserCookie) {
          showToast("Error: Not logged in.", "error");
          return;
        }
        const user = JSON.parse(storedUserCookie);
        const discordId = user.id;

        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item');
        if (!itemId) {
          showToast("Error: Item not found.", "error");
          return;
        }

        const newPrice1 = document.getElementById('modal-market-price').value || 0;
        const newPrice2 = document.getElementById('modal-npc-price').value || 0;

        const endpoint = `https://data-manager.roumakdatta.workers.dev/item/${discordId}/${itemId}/${newPrice1}/${newPrice2}`;
        const res = await fetch(endpoint);
        const data = await res.json();

        if (data.success) {
          showToast(
            `✅ ${data.itemName} updated!\nMarket: ${formatPrice(data.oldPrice)} → ${formatPrice(data.newPrice)}\nNPC: ${formatPrice(data.oldNpcPrice)} → ${formatPrice(data.newNpcPrice)}`,
            "success"
          );
          closePriceModal();
          await loadItemDetails();
        } else {
          const reason = data.response?.message || "Unknown error";
          showToast(`❌ Failed to update: ${reason}`, "error");
        }
      } catch (err) {
        console.error("Submit error:", err);
        showToast("Something went wrong while submitting.", "error");
      }
    }

    document.getElementById("prevItemBtn").addEventListener("click", goToPrevItem);
    document.getElementById("nextItemBtn").addEventListener("click", goToNextItem);

    async function initializePage() {
      await loadUserInfo();
      await fetchAllItems();
      await loadItemDetails();
    }
    initializePage();
  </script>
</body>
</html>
